<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Harga Emas</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <!-- Load Montserrat Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Konfigurasi untuk font Montserrat */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom colors based on user request */
        /* Galeri 24 Theme */
        .color-g24-bg { background-color: #F5EDCC; }
        .color-g24-text { color: #8B8159; } 
        .color-g24-dark { color: #A69C75; }

        /* Antam Theme */
        .color-antam-bg { background-color: #F0FDFB; } 
        .color-antam-dark { color: #00726B; } 
        .color-antam-medium { color: #009688; } 

        /* Responsive design for the chart container */
        .chart-container {
            position: relative;
            height: 55vh; 
            width: 100%;
        }
        /* Mengurangi ketebalan font default */
        .font-extrabold { font-weight: 700; } 
        .font-bold { font-weight: 600; }
        
        /* Gaya kustom untuk radio button yang modern */
        .radio-group input[type="radio"] {
            display: none;
        }
        .radio-group label {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 9999px;
            transition: all 0.2s;
            font-weight: 500;
            color: #6B7280;
            border: 1px solid #D1D5DB;
            background-color: #FFFFFF;
            font-size: 0.875rem;
        }
        .radio-group label:hover {
            background-color: #F3F4F6;
        }
        .radio-group input[type="radio"]:checked + label {
            background-color: #00726B;
            color: #FFFFFF;
            border-color: #00726B;
            box-shadow: 0 2px 4px -1px rgba(0, 114, 107, 0.1), 0 1px 2px -1px rgba(0, 114, 107, 0.1);
        }
    </style>
</head>
<body>
    <div class="max-w-5xl mx-auto p-4 sm:p-8 bg-white shadow-2xl rounded-3xl mt-10 mb-10 border-t-4 border-yellow-500">
        <!-- HEADER -->
        <header class="text-center mb-10">
            <h1 class="text-xl sm:text-3xl font-bold text-gray-800 tracking-tight mb-2">
                Monitoring Harga Emas
            </h1>
            
            <!-- Pilihan Berat Emas -->
            <div class="flex justify-center mb-4">
                <div class="radio-group flex gap-2 bg-gray-100 p-1 rounded-lg">
                    <div>
                        <input type="radio" id="berat_1" name="chart_berat" value="1" checked onchange="changeBerat('1')">
                        <label for="berat_1">1 Gram</label>
                    </div>
                    <div>
                        <input type="radio" id="berat_2" name="chart_berat" value="2" onchange="changeBerat('2')">
                        <label for="berat_2">2 Gram</label>
                    </div>
                </div>
            </div>
            
            <p class="text-md sm:text-sm color-antam-medium font-small">
                Data Harian Emas <span id="currentBerat">1</span> Gram - Diperbarui <span id="latestTanggal">-</span> pukul <span id="latestJam">-</span> (WIB)
            </p>
        </header>
        
        <!-- BAGIAN HARGA TERBARU (Cards) -->
        <div class="mb-12">
            <h2 class="text-xl sm:text-xl font-bold text-gray-700 mb-6 border-b pb-2">Harga Jual & Buyback</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- Card GALERI 24 -->
                <div class="color-g24-bg border border-gray-300 p-6 rounded-2xl shadow-lg transition duration-300 hover:shadow-xl hover:scale-[1.01]">
                    <h3 class="text-xl font-bold color-g24-text mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="#A69C75" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        GALERI 24
                    </h3>
                    
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-medium text-gray-600">Harga Jual:</p>
                        <p id="g24_jual_price" class="text-2xl font-bold color-g24-text">Rp -</p>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-gray-400">
                        <p class="text-sm font-medium text-gray-600">Harga Buyback:</p>
                        <p id="g24_buyback_price" class="text-xl font-bold color-g24-dark">Rp -</p>
                    </div>
                </div>

                <!-- Card ANTAM -->
                <div class="border border-gray-300 p-6 rounded-2xl shadow-lg transition duration-300 hover:shadow-xl hover:scale-[1.01] color-antam-bg">
                    <h3 class="text-xl font-bold color-antam-dark mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="#00726B" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V6m-6 6h2m-2 0a2 2 0 100 4m0 4v2m0-6V6m6 10H6m-2 0a2 2 0 110 4m0 4v2m-2-6h2m6-4a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V6m6 6h2m-2 0a2 2 0 100 4m0 4v2m0-6V6m6 6h2m-2 0a2 2 0 110 4m0 4v2m0-6V6"></path></svg>
                        ANTAM
                    </h3>
                    
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-medium text-gray-600">Harga Jual:</p>
                        <p id="antam_jual_price" class="text-2xl font-bold color-antam-dark">Rp -</p>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-gray-400">
                        <p class="text-sm font-medium text-gray-600">Harga Buyback:</p>
                        <p id="antam_buyback_price" class="text-xl font-bold color-antam-medium">Rp -</p>
                    </div>
                </div>

                <!-- Card UBS -->
                <div class="border border-gray-300 p-6 rounded-2xl shadow-lg transition duration-300 hover:shadow-xl hover:scale-[1.01]" style="background-color: #F0F4FF; border-color: #032885;">
                    <h3 class="text-xl font-bold mb-4 flex items-center" style="color: #032885;">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="#032885" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        UBS
                    </h3>
                    
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-sm font-medium text-gray-600">Harga Jual:</p>
                        <p id="ubs_jual_price" class="text-2xl font-bold" style="color: #032885;">Rp -</p>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-gray-400">
                        <p class="text-sm font-medium text-gray-600">Harga Buyback:</p>
                        <p id="ubs_buyback_price" class="text-xl font-bold" style="color: #1E40AF;">Rp -</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- BAGIAN GRAFIK HARGA -->
        <div class="mb-8 p-6 border border-gray-200 rounded-2xl shadow-xl bg-gray-50">
            <h2 class="text-xl sm:text-xl font-bold text-gray-700 mb-4">Grafik Harga Historis</h2>
            
            <!-- Filter Group -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <!-- Radio Button Group untuk memilih Jual/Buyback -->
                <div class="radio-group flex gap-2">
                    <div>
                        <input type="radio" id="chart_jual" name="chart_type" value="jual" checked onchange="updateChart()">
                        <label for="chart_jual">Harga Jual</label>
                    </div>
                    <div>
                        <input type="radio" id="chart_buyback" name="chart_type" value="buyback" onchange="updateChart()">
                        <label for="chart_buyback">Harga Buyback</label>
                    </div>
                </div>

                <!-- Radio Button Group untuk memilih Vendor -->
                <div class="radio-group flex gap-2 ml-auto">
                    <div>
                        <input type="radio" id="vendor_both" name="chart_vendor" value="both" checked onchange="updateChart()">
                        <label for="vendor_both">Semua</label>
                    </div>
                    <div>
                        <input type="radio" id="vendor_g24" name="chart_vendor" value="g24" onchange="updateChart()">
                        <label for="vendor_g24">GALERI 24</label>
                    </div>
                    <div>
                        <input type="radio" id="vendor_antam" name="chart_vendor" value="antam" onchange="updateChart()">
                        <label for="vendor_antam">ANTAM</label>
                    </div>
                    <div>
                        <input type="radio" id="vendor_ubs" name="chart_vendor" value="ubs" onchange="updateChart()">
                        <label for="vendor_ubs">UBS</label>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
            <p class="text-xs text-gray-500 mt-4 text-center">Menampilkan data perubahan harga. Arahkan kursor ke garis untuk melihat detail harga.</p>
        </div>
        
        <footer class="text-center text-sm text-gray-500 pt-6 border-t mt-6">
            <p>Aplikasi Monitoring Harga Emas (Data Real-time)</p>
        </footer>
    </div>

    <script>
    // =======================================================
    // VARIABEL GLOBAL - DISEDERHANAKAN
    // =======================================================
    let chartData = {
        dates: [],
        g24_jual: [],
        antam_jual: [],
        g24_buyback: [],
        antam_buyback: [],
        latest: {}
    };

    let currentBerat = '1';
    let priceChartInstance = null;

    // =======================================================
    // FUNGSI UTAMA - DISEDERHANAKAN
    // =======================================================

    async function fetchGoldData(berat = '1') {
        try {
            const response = await fetch(`/api/gold-data?berat=${berat}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            
            if (data.isEmpty || data.dates.length === 0) {
                console.log(`ðŸ“­ No REAL data available for ${berat}g, returning empty dataset`);
                return data;
            }
            
            return data;
        } catch (error) {
            console.error('Error fetching gold data:', error);
            return {
                berat: berat,
                dates: [],
                g24_jual: [],
                antam_jual: [],
                g24_buyback: [],
                antam_buyback: [],
                latest: {},
                error: 'Gagal mengambil data dari server',
                isEmpty: true
            };
        }
    }

    // Fungsi untuk mengganti berat - DISEDERHANAKAN
    async function changeBerat(berat) {
        console.log(`Changing berat to: ${berat}g`);
        currentBerat = berat;
        
        // Update teks berat
        document.getElementById('currentBerat').textContent = berat;
        
        // Ambil data baru
        const newData = await fetchGoldData(berat);
        chartData = newData;
        
        // Render ulang
        renderLatestPrices();
        updateChart();
        
        // Update URL tanpa reload page
        const url = new URL(window.location);
        url.searchParams.set('berat', berat);
        window.history.pushState({}, '', url);
    }

    // Inisialisasi chart - DISEDERHANAKAN
    async function initChart() {
        console.log('Initializing chart...');
        
        // Cek parameter URL untuk berat
        const urlParams = new URLSearchParams(window.location.search);
        const urlBerat = urlParams.get('berat');
        if (urlBerat && ['1', '2'].includes(urlBerat)) {
            currentBerat = urlBerat;
            document.getElementById(`berat_${urlBerat}`).checked = true;
            document.getElementById('currentBerat').textContent = urlBerat;
        }
        
        // Ambil data dari backend
        const newData = await fetchGoldData(currentBerat);
        chartData = newData;
        
        console.log('New data received:', chartData);
        
        // Render harga terbaru
        renderLatestPrices();
        
        // Inisialisasi chart jika ada data
        if (chartData.dates && chartData.dates.length > 0) {
            updateChart();
        }
    }

    // =======================================================
    // HELPER FUNCTION
    // =======================================================
    
    function formatRupiah(angka) {
        if (!angka && angka !== 0) return "Rp -";
        const number = parseFloat(angka);
        return "Rp " + number.toLocaleString('id-ID', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }

    function formatTanggalDisplay(tanggalStr) {
        if (!tanggalStr) return "-";
        try {
            const [year, month, day] = tanggalStr.split('-');
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            return `${parseInt(day)} ${monthNames[parseInt(month) - 1]} ${year}`;
        } catch (e) {
            return tanggalStr;
        }
    }

    function formatJamDisplay(jamStr) {
        if (!jamStr) return "-";
        try {
            return jamStr.substring(0, 5);
        } catch (e) {
            return jamStr;
        }
    }

// Update fungsi renderLatestPrices untuk UBS
function renderLatestPrices() {
    console.log('Rendering latest prices:', chartData.latest);
    console.log('Data status:', chartData.isEmpty ? 'EMPTY' : 'HAS DATA');
    
    const latestTanggalElem = document.getElementById('latestTanggal');
    const latestJamElem = document.getElementById('latestJam');
    const g24JualElem = document.getElementById('g24_jual_price');
    const g24BuybackElem = document.getElementById('g24_buyback_price');
    const antamJualElem = document.getElementById('antam_jual_price');
    const antamBuybackElem = document.getElementById('antam_buyback_price');
    const ubsJualElem = document.getElementById('ubs_jual_price');
    const ubsBuybackElem = document.getElementById('ubs_buyback_price');

    if (chartData.latest && chartData.latest.Tanggal && !chartData.isEmpty) {
        // Data REAL tersedia
        latestTanggalElem.textContent = formatTanggalDisplay(chartData.latest.Tanggal);
        latestJamElem.textContent = formatJamDisplay(chartData.latest.Jam);

        // Handle data yang mungkin null/undefined
        g24JualElem.textContent = formatRupiah(chartData.latest.GALERI24_Jual);
        g24BuybackElem.textContent = formatRupiah(chartData.latest.GALERI24_Buyback);
        antamJualElem.textContent = formatRupiah(chartData.latest.ANTAM_Jual);
        antamBuybackElem.textContent = formatRupiah(chartData.latest.ANTAM_Buyback);
        ubsJualElem.textContent = formatRupiah(chartData.latest.UBS_Jual);
        ubsBuybackElem.textContent = formatRupiah(chartData.latest.UBS_Buyback);
    } else {
        // Data kosong atau error
        latestTanggalElem.textContent = "Menunggu data...";
        latestJamElem.textContent = "-";
        g24JualElem.textContent = "Rp -";
        g24BuybackElem.textContent = "Rp -";
        antamJualElem.textContent = "Rp -";
        antamBuybackElem.textContent = "Rp -";
        ubsJualElem.textContent = "Rp -";
        ubsBuybackElem.textContent = "Rp -";
    }
}

    // =======================================================
    // CHART LOGIC
    // =======================================================

    // Update chart untuk UBS
    function updateChart() {
        if (!chartData.dates || chartData.dates.length === 0 || chartData.isEmpty) {
            console.log("ðŸ“­ Data grafik kosong untuk", currentBerat + 'g');
            
            const ctx = document.getElementById('priceChart');
            if (ctx) {
                ctx.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-2">ðŸ“­</div>
                            <p class="font-semibold">Data untuk ${currentBerat} gram belum tersedia</p>
                            <p class="text-sm mt-2">Data akan muncul setelah berhasil di-scrape</p>
                            ${chartData.error ? `<p class="text-xs text-red-500 mt-1">${chartData.error}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        const chartType = document.querySelector('input[name="chart_type"]:checked').value;
        const vendorType = document.querySelector('input[name="chart_vendor"]:checked').value;
        
        const isJual = chartType === 'jual';
        
        // Pilih dataset berdasarkan vendor type
        let datasets = [];
        
        if (vendorType === 'both' || vendorType === 'g24') {
            datasets.push({
                label: isJual ? 'Galeri 24 (Jual)' : 'Galeri 24 (Buyback)',
                data: isJual ? chartData.g24_jual : chartData.g24_buyback,
                borderColor: '#A69C75', 
                backgroundColor: 'rgba(166, 156, 117, 0.1)',
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#A69C75',
                pointBorderColor: '#A69C75',
                pointHoverRadius: 5,
                fill: vendorType === 'g24',
            });
        }
        
        if (vendorType === 'both' || vendorType === 'antam') {
            datasets.push({
                label: isJual ? 'ANTAM (Jual)' : 'ANTAM (Buyback)',
                data: isJual ? chartData.antam_jual : chartData.antam_buyback,
                borderColor: '#00726B', 
                backgroundColor: 'rgba(0, 114, 107, 0.1)',
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#00726B',
                pointBorderColor: '#00726B',
                pointHoverRadius: 5,
                fill: vendorType === 'antam',
            });
        }
        
        if (vendorType === 'both' || vendorType === 'ubs') {
            datasets.push({
                label: isJual ? 'UBS (Jual)' : 'UBS (Buyback)',
                data: isJual ? chartData.ubs_jual : chartData.ubs_buyback,
                borderColor: '#032885', 
                backgroundColor: 'rgba(3, 40, 133, 0.1)',
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3,
                pointBackgroundColor: '#032885',
                pointBorderColor: '#032885',
                pointHoverRadius: 5,
                fill: vendorType === 'ubs',
            });
        }
        
        const titleText = isJual ? 
            'Grafik Harga Jual Emas Historis' : 
            'Grafik Harga Buyback Emas Historis';

        const config = {
            type: 'line', 
            data: {
                labels: chartData.dates, 
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                scales: {
                    x: {
                        grid: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'Tanggal & Waktu',
                            font: {
                                size: 12, 
                                family: 'Montserrat',
                                weight: '500' 
                            }
                        },
                        ticks: {
                            font: {
                                size: 9,
                                family: 'Montserrat'
                            },
                            maxTicksLimit: 10,
                            callback: function(value, index, values) {
                                if (chartData.dates.length > 20) {
                                    return index % Math.ceil(chartData.dates.length / 10) === 0 ? value : '';
                                }
                                return value;
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Harga (Rp)',
                            font: {
                                size: 12,
                                family: 'Montserrat',
                                weight: '500'
                            }
                        },
                        beginAtZero: false,
                        ticks: {
                            callback: function(value, index, ticks) {
                                return formatRupiah(value);
                            },
                            font: {
                                size: 9,
                                family: 'Montserrat'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 10, 
                            font: {
                                size: 12, 
                                family: 'Montserrat',
                                weight: '500'
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: titleText,
                        font: {
                            size: 14, 
                            family: 'Montserrat',
                            weight: '600'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatRupiah(context.parsed.y);
                                }
                                return label;
                            },
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                return chartData.dates[index];
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                elements: {
                    point: {
                        hoverBackgroundColor: '#ffffff',
                        hoverBorderColor: function(context) {
                            return context.dataset.borderColor;
                        },
                        hoverBorderWidth: 2
                    }
                }
            }
        };

        const ctx = document.getElementById('priceChart');
        if (!ctx) {
            console.error('Canvas element for chart not found');
            return;
        }

        if (priceChartInstance) {
            priceChartInstance.data.datasets = datasets;
            priceChartInstance.data.labels = chartData.dates;
            priceChartInstance.options.plugins.title.text = titleText;
            priceChartInstance.update();
        } else {
            priceChartInstance = new Chart(ctx, config);
        }
    }

    // Auto-refresh data setiap 30 detik
    setInterval(async () => {
        console.log('Auto-refresh triggered for', currentBerat + 'g');
        const newData = await fetchGoldData(currentBerat);
        if (newData) {
            chartData = newData;
            renderLatestPrices();
            
            if (priceChartInstance) {
                updateChart();
            }
        }
    }, 30000);

    // Panggil inisialisasi saat halaman dimuat
    window.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded');
        initChart();
    });
    </script>
</body>
</html>